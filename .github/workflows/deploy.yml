name: Docker Compose Deploy CI

on:
  push:
    branches: ['master']
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - uses: actions/checkout@v3

      - name: Make sure everything is correctly installed
        run: |
          if ! command -v docker &> /dev/null
            then
              echo "Cannot find docker, please install docker first"
              exit
            fi
        shell: bash

      - name: Create secret .env file
        run: 'echo "$SECRET" > .env'
        shell: bash
        env:
          SECRET: ${{ secrets.ENV }}

      - name: Install node_modules
        run: npm i

      - name: Build project
        run: npm run build

      - name: Run project
        run: npm run start
